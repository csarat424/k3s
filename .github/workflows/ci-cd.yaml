name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Install k3s
        run: |
          curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable=traefik" sh -
          # Verify k3s installation
          k3s --version

      - name: Wait for k3s to be Ready
        run: |
          kubectl wait --for=condition=Ready node/${HOSTNAME} --timeout=180s
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

      - name: Build & Load Docker Image
        run: |
          docker build -t flask-app:latest .
          docker save flask-app:latest | sudo k3s ctr images import -
          # Verify image import
          sudo k3s ctr images ls | grep flask-app

      - name: Deploy with Helm
        run: |
          helm install flask-app ./chart --wait --timeout 5m
          # Verify deployment
          kubectl get deployments -l app=flask-app
          kubectl get pods -l app=flask-app

      - name: Basic Integration Test
        run: |
          kubectl run test-pod --rm --restart=Never --image=python:3.9-slim -- sh -c "
            pip install requests &&
            curl -s http://flask-app-service/health || exit 1
          "

      - name: Cleanup
        if: always
        run: |
          helm uninstall flask-app || true
          sudo k3s-uninstall.sh || true

          
